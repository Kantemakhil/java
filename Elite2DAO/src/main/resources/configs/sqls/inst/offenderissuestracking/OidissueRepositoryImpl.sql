
OIDISSUE_FIND_RGAGYLOC {
 	SELECT  AGY_LOC1.DESCRIPTION DESCRIPTION ,AGY_LOC1.AGY_LOC_ID CODE,
	CASE 
	WHEN DEACTIVATION_DATE IS NULL AND AGY_LOC1.AGY_LOC_ID NOT IN ( 'TRN' , 'OUT' ) AND AGENCY_LOCATION_TYPE = 'INST' THEN 'Y'
	ELSE 'N' END SEAL_FLAG
	FROM AGENCY_LOCATIONS AGY_LOC1 ORDER BY AGY_LOC1.DESCRIPTION , AGY_LOC1.AGY_LOC_ID
}

OIDISSUE_FIND_RGAGYLOCALL {
 	SELECT AGY_LOC1.AGY_LOC_ID , AGY_LOC1.DESCRIPTION  FROM AGENCY_LOCATIONS AGY_LOC1 WHERE AGY_LOC1.AGY_LOC_ID NOT IN ( 'TRN' , 'OUT' ) AND AGENCY_LOCATION_TYPE = 'INST' ORDER BY AGY_LOC1.DESCRIPTION , AGY_LOC1.AGY_LOC_ID
}

OIDISSUE_FIND_RGGRIEVTYPE {
select
	DESCRIPTION ,
	GRIEV_TYPE CODE,
	ACTIVE_FLAG,
	staff_involved_flag,
	case
		when (
		select
			count(*)
		from
			grievance_types_permissions gtp
		where
			griev_type = gt.griev_type
			and create_amend_flag = 'Y'
			and role_id in(
			select
				ROLE_ID
			from
				STAFF_MEMBER_ROLES
			where
				staff_id = (
				select
					staff_id
				from
					STAFF_MEMBERS
				where
					LOWER(user_ID) = LOWER(:user))) ) > 0 then 'Y'
		else 'N'
	end as create_flag
from
	GRIEVANCE_TYPES gt
order by
	LIST_SEQ;
}

OIDISSUE_FIND_RGGRIEVREASON {
select
	DESCRIPTION ,
	GRIEV_REASON_CODE CODE,
	ACTIVE_FLAG,
	case
		when (
		select
			count(*)
		from
			grievance_types_permissions gtp
		where
			griev_type = gr.griev_type and GRIEV_REASON_CODE = gr.GRIEV_REASON_CODE
			and create_amend_flag = 'Y'
			and role_id in(
			select
				ROLE_ID
			from
				STAFF_MEMBER_ROLES
			where
				staff_id = (
				select
					staff_id
				from
					STAFF_MEMBERS
				where
					LOWER(user_ID) = LOWER(:user))) ) > 0 then 'Y'
		else 'N'
	end as create_flag
from
	GRIEVANCE_REASONS gr
where
	GRIEV_TYPE = :GRIEVTYPE
order by
	LIST_SEQ;
}

OIDISSUE_FIND_RGGRIEVREASONALL {
 	SELECT GRIEV_REASON_CODE , DESCRIPTION FROM GRIEVANCE_REASONS WHERE GRIEV_TYPE = :GRIEVTYPE ORDER BY LIST_SEQ
}

OIDISSUE_FIND_RGTXNTYPE {
 	SELECT DESCRIPTION , TXN_TYPE FROM GRIEVANCE_TXNS WHERE GRIEV_TYPE = :GRIEVTYPE AND ACTIVE_FLAG = 'Y'  ORDER BY LIST_SEQ
}

OIDISSUE_FIND_RGTXNTYPEALL {
 	 SELECT TXN_TYPE , DESCRIPTION,ACTIVE_FLAG FROM GRIEVANCE_TXNS WHERE GRIEV_TYPE = :GRIEVTYPE ORDER BY LIST_SEQ
}

OIDISSUE_FIND_RGSTAFF {
 	SELECT USER_ID , LAST_NAME||', '||FIRST_NAME DESCRIPTION , STAFF_ID  FROM STAFF_MEMBERS WHERE STAFF_ID   IN (SELECT STAFF_ID                         FROM STAFF_ACCESSIBLE_CASELOADS                        WHERE CASELOAD_ID = (SELECT WORKING_CASELOAD_ID FROM STAFF_MEMBERS WHERE USER_ID =:userId) )  AND STATUS = 'ACTIVE' ORDER BY DESCRIPTION
}

OIDISSUE_FIND_RGSTAFFALL {
 	SELECT USER_ID , LAST_NAME||', '||FIRST_NAME AS NAME , STAFF_ID FROM STAFF_MEMBERS  ORDER BY USER_ID
}

OIDISSUE_FIND_RGFINDING {
 	SELECT DESCRIPTION ,CODE FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_FINDIN' AND ('' = 'ENTER-QUERY' OR ACTIVE_FLAG = 'Y' ) ORDER BY DESCRIPTION , CODE
}

OIDISSUE_FIND_RGFINDINGALL {
 	SELECT CODE , DESCRIPTION FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_FINDIN' ORDER BY DESCRIPTION , CODE
}

OIDISSUE_FIND_RGLEVEL {
 	SELECT  DESCRIPTION ,CODE FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_LEVEL' AND ('' = 'ENTER-QUERY' OR ACTIVE_FLAG = 'Y' ) ORDER BY DESCRIPTION , CODE
}

OIDISSUE_FIND_RGLEVELALL {
 	SELECT CODE , DESCRIPTION FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_LEVEL' ORDER BY DESCRIPTION , CODE
}

OIDISSUE_FIND_RGSTATUS {
 	SELECT  DESCRIPTION ,CODE FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_STATUS' AND ('' = 'ENTER-QUERY' OR ACTIVE_FLAG = 'Y' ) ORDER BY DESCRIPTION , CODE
}

OIDISSUE_OFFENDERGRIEVANCES_FIND_OFFENDER_GRIEVANCES {
select GRIEVANCE_ID , OFFENDER_BOOK_ID , REPORT_DATE , GRIEV_TYPE , GRIEV_REASON_CODE , AGENCY_INCIDENT_ID , PARTY_SEQ , CLAIM_AMOUNT , AGY_LOC_ID , COMMENT_TEXT , MODIFY_USER_ID , MODIFY_DATETIME , CREATE_DATETIME , CREATE_USER_ID , SEAL_FLAG, case when ( select COUNT(1) from GRIEVANCE_TYPES_PERMISSIONS GTP where GRIEV_TYPE = OG.GRIEV_TYPE and GRIEV_REASON_CODE = OG.GRIEV_REASON_CODE and CREATE_AMEND_FLAG = 'Y' and ROLE_ID in( select ROLE_ID from STAFF_MEMBER_ROLES where STAFF_ID = ( select STAFF_ID from STAFF_MEMBERS where LOWER(USER_ID) = LOWER(:user))) ) > 0 then 'Y' else 'N' end as CREATE_FLAG from OFFENDER_GRIEVANCES OG where OFFENDER_BOOK_ID =:OFFENDERBOOKID and exists ( select 'Y' from GRIEVANCE_TYPES_PERMISSIONS GTP where GRIEV_TYPE = OG.GRIEV_TYPE and GRIEV_REASON_CODE = OG.GRIEV_REASON_CODE and VIEW_FLAG = 'Y' and ROLE_ID in( select ROLE_ID from STAFF_MEMBER_ROLES where STAFF_ID = ( select STAFF_ID from STAFF_MEMBERS where LOWER(USER_ID) = LOWER(:user))) ) order by REPORT_DATE desc, GRIEVANCE_ID desc;
}
OIDISSUE_OFFENDERGRIEVANCES_INSERT_OFFENDER_GRIEVANCES {
	insert into OFFENDER_GRIEVANCES(GRIEVANCE_ID , OFFENDER_BOOK_ID , REPORT_DATE , GRIEV_TYPE , GRIEV_REASON_CODE , AGENCY_INCIDENT_ID , PARTY_SEQ , CLAIM_AMOUNT , AGY_LOC_ID , COMMENT_TEXT , MODIFY_DATETIME , CREATE_DATETIME , CREATE_USER_ID , MODIFY_USER_ID, SEAL_FLAG ) values(:grievanceId , :offenderBookId , :reportDate , :grievType , :grievReasonCode , :agencyIncidentId , :partySeq , :claimAmount , :agyLocId , :commentText , null , current_timestamp , :createUserId , null, :sealFlag )
	}

OIDISSUE_OFFENDERGRIEVANCES_UPDATE_OFFENDER_GRIEVANCES {
	UPDATE OFFENDER_GRIEVANCES set GRIEVANCE_ID  =:grievanceId ,OFFENDER_BOOK_ID  =:offenderBookId ,REPORT_DATE  =:reportDate ,GRIEV_TYPE  =:grievType ,GRIEV_REASON_CODE  =:grievReasonCode ,AGENCY_INCIDENT_ID  =:agencyIncidentId ,PARTY_SEQ  =:partySeq ,CLAIM_AMOUNT  =:claimAmount ,AGY_LOC_ID  =:agyLocId ,COMMENT_TEXT  =:commentText ,MODIFY_USER_ID  =:modifyUserId ,MODIFY_DATETIME  = current_timestamp ,SEAL_FLAG  =:sealFlag WHERE GRIEVANCE_ID  =:grievanceId
}

OIDISSUE_OFFENDERGRIEVANCETXNS_FIND_OFFENDER_GRIEVANCE_TXNS {
 	SELECT GRIEVANCE_ID ,TXN_SEQ ,START_DATE ,END_DATE ,GRIEV_TYPE ,TXN_TYPE ,FINDING ,ASSIGNED_STAFF_ID ,GRIEV_LEVEL ,CREATE_USER_ID ,CREATE_DATETIME ,STATUS ,PROPOSED_RESPONSE ,OFFICIAL_RESPONSE ,MODIFY_DATETIME ,MODIFY_USER_ID ,SEAL_FLAG   FROM OFFENDER_GRIEVANCE_TXNS WHERE GRIEVANCE_ID=:GRIEVANCEID ORDER BY TXN_SEQ DESC
}
OIDISSUE_OFFENDERGRIEVANCETXNS_INSERT_OFFENDER_GRIEVANCE_TXNS {
	insert into OFFENDER_GRIEVANCE_TXNS(GRIEVANCE_ID , TXN_SEQ , START_DATE , END_DATE , GRIEV_TYPE , TXN_TYPE , FINDING , ASSIGNED_STAFF_ID , GRIEV_LEVEL , CREATE_USER_ID , CREATE_DATETIME , STATUS , PROPOSED_RESPONSE , OFFICIAL_RESPONSE , MODIFY_DATETIME , SEAL_FLAG ) values(:grievanceId , :txnSeq , :startDate , :endDate , :grievType , :txnType , :finding , :assignedStaffId , :grievLevel , :createUserId , current_timestamp , :status , :proposedResponse , :officialResponse , null , :sealFlag )
	}

OIDISSUE_OFFENDERGRIEVANCETXNS_UPDATE_OFFENDER_GRIEVANCE_TXNS {
	UPDATE OFFENDER_GRIEVANCE_TXNS set GRIEVANCE_ID  =:grievanceId ,TXN_SEQ  =:txnSeq ,START_DATE  =:startDate ,END_DATE  =:endDate ,GRIEV_TYPE  =:grievType ,TXN_TYPE  =:txnType ,FINDING  =:finding ,ASSIGNED_STAFF_ID  =:assignedStaffId ,GRIEV_LEVEL  =:grievLevel ,STATUS  =:status ,PROPOSED_RESPONSE  =:proposedResponse ,OFFICIAL_RESPONSE  =:officialResponse ,MODIFY_DATETIME  = current_timestamp ,MODIFY_USER_ID  =:modifyUserId ,SEAL_FLAG  =:sealFlag WHERE GRIEVANCE_ID  =:grievanceId AND TXN_SEQ  =:txnSeq
}

OIDISSUE_OFFENDERGRIEVANCETXNS_DELETE_OFFENDER_GRIEVANCE_TXNS { 
	DELETE FROM OFFENDER_GRIEVANCE_TXNS  WHERE GRIEVANCE_ID  = :grievanceId AND TXN_SEQ  = :txnSeq
}


OIDISSUE_OFF_BKG_ONCHECKDELETEMASTER_ {
	SELECT 1 FROM OFFENDER_GRIEVANCES O WHERE O.OFFENDER_BOOK_ID = :OFFENDERBOOKID
}

OIDISSUE_OFFENDER_GRIEVANCES_KEYDELREC_ {
	SELECT 'X' FROM OMS_OWNER.OFFENDER_GRIEVANCE_TXNS WHERE GRIEVANCE_ID = :GRIEVANCEID
}

OIDISSUE_OFFENDER_GRIEVANCES_KEYDELREC_ {
	SELECT 'X' FROM OMS_OWNER.OFFENDER_GRIEV_STAFFS WHERE GRIEVANCE_ID = :GRIEVANCEID
}

OIDISSUE_OFFENDER_GRIEVANCES_POSTQUERY_STATUS_GRIEV_LEVEL {
	SELECT GRIEV_LEVEL,STATUS FROM OFFENDER_GRIEVANCE_TXNS WHERE GRIEVANCE_ID = :GRIEVANCEID ORDER BY TXN_SEQ
}

OIDISSUE_OFFENDER_GRIEVANCES_POSTQUERY_STATUS {
	SELECT GRIEV_LEVEL,STATUS FROM OFFENDER_GRIEVANCE_TXNS T WHERE T.GRIEVANCE_ID = :GRIEVANCEID AND EXISTS (SELECT '1' FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_STATUS' AND CODE = T.STATUS AND PARENT_CODE = 'ACTIVE') ORDER BY T.TXN_SEQ DESC
}

OIDISSUE_OFFENDER_GRIEVANCES_POSTQUERY_GRIEV_LEVEL {
	SELECT DESCRIPTION
        FROM REFERENCE_CODES
       WHERE DOMAIN = 'GRIEV_LEVEL'
         AND CODE = :GRIEVLEVEL
}

OIDISSUE_OFFENDER_GRIEVANCES_POSTQUERY_REPORT_DATE {
	SELECT DESCRIPTION FROM AGENCY_LOCATIONS WHERE AGY_LOC_ID = :AGYLOCID
}

OIDISSUE_OFFENDER_GRIEVANCES_POSTQUERYLV_GRIEVANCE_DESC_CUR {
	SELECT DESCRIPTION STATUS FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_STATUS' AND CODE = :currStatus
}

OIDISSUE_OFFENDER_GRIEVANCES_POSTQUERY_GRIEVANCE_DESC_CUR {
	SELECT DESCRIPTION INTO :OFFENDER_GRIEVANCES.CURR_LEVEL FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_LEVEL' AND CODE = V_CURR_LEV_STAT_REC.GRIEV_LEVEL
}

OIDISSUE_OFFENDER_GRIEVANCES_PREINSERT {
select NEXTVAL('GRIEVANCE_ID')
}

OIDISSUE_OFFENDER_GRIEVANCES_WHENNEWRECORDINSTANCE {
	SELECT DESCRIPTION FROM AGENCY_LOCATIONS WHERE AGY_LOC_ID = :AGYLOCID
}

OIDISSUE_OFFENDER_GRIEVANCES_ONCHECKDELETEMASTER_ {
	SELECT 1 FROM OFFENDER_GRIEVANCE_TXNS O WHERE O.GRIEVANCE_ID = :GRIEVANCEID
}

OIDISSUE_OFFENDER_GRIEVANCE_TXNS_POSTQUERY_ {
	SELECT PARENT_CODE FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_STATUS' AND CODE = :STATUS
}

OIDISSUE_OFFENDER_GRIEVANCE_TXNS_POSTQUERY_ {
	SELECT USER_ID, LAST_NAME||', '||FIRST_NAME as NAME FROM STAFF_MEMBERS WHERE STAFF_ID = :ASSIGNEDSTAFFID

}

OIDISSUE_OFFENDER_GRIEVANCE_TXNS_WHENNEWRECORDINSTANCE_ {
	SELECT 1 FROM OFFENDER_GRIEVANCE_TXNS WHERE GRIEVANCE_ID = :GRIEVANCEID AND TXN_SEQ = :TXNSEQ
}

OIDISSUE_OFFENDER_GRIEVANCE_TXNS_WHENNEWRECORDINSTANCE_ {
	SELECT CODE, DESCRIPTION FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_STATUS'
}

OIDISSUE_OFFENDER_GRIEVANCE_TXNS_PREINSERT {
	SELECT coalesce (MAX(TXN_SEQ), 0) + 1 FROM OFFENDER_GRIEVANCE_TXNS WHERE GRIEVANCE_ID = :GRIEVANCEID
}

OIDISSUE_OFFENDER_GRIEVANCE_TXNS_WHENVALIDATERECORD_ {
	SELECT PARENT_CODE FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_STATUS' AND CODE = V_CODE AND ACTIVE_FLAG = 'Y'
}

OIDISSUE_OFFENDER_GRIEVANCE_TXNS_WHENVALIDATEREC {
	SELECT STAFF_INVOLVED_FLAG FROM GRIEVANCE_TYPES WHERE GRIEV_TYPE = :LV_TYPE
}

OIDISSUE_OFFENDER_GRIEVANCE_TXNS_WHENVALIDATERECORD_ {
	SELECT STAFF_INVOLVED_FLAG FROM GRIEVANCE_TYPES WHERE GRIEV_TYPE = LV_TYPE
}

OIDISSUE_OFFENDER_GRIEVANCE_TXNS_WHENVALIDATERECORD_ {
	SELECT 'X' FROM OMS_OWNER.GRIEVANCE_TXNS WHERE GRIEV_TYPE = :GRIEVTYPE AND TXN_TYPE = :TXNTYPE
}

OIDISSUE_OIDISSUE_WHENNEWFORMINSTANCE {
	SELECT count(*) FROM STAFF_MEMBERS      SM, STAFF_MEMBER_ROLES SMR, OMS_ROLES          OMR, MODULE_PRIVILEGES  MP WHERE SM.USER_ID = :userName AND SM.STAFF_ID = SMR.STAFF_ID AND SMR.ROLE_ID = OMR.ROLE_ID AND OMR.ROLE_CODE = 'GRIEVANCE_COORDINATOR' AND OMR.ROLE_ID = MP.ROLE_ID AND MP.MODULE_NAME = 'OIDISSUE' AND MP.ACCESS_PRIVILEGE = 'A'
}

OIDISSUE_OIDISSUE_KEYCOMMIT_ {
	SELECT PARENT_CODE FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_STATUS' AND CODE = V_CODE AND ACTIVE_FLAG = 'Y'
}

OIDISSUE_CREATE_FORM_GLOBALS {
	SELECT DESCRIPTION INTO V_FORM_DESC FROM OMS_MODULES WHERE MODULE_NAME = V_FORM_NAME
}

OIDISSUE_IS_ACTIVE_TXN_ {
	SELECT PARENT_CODE FROM REFERENCE_CODES WHERE DOMAIN = 'GRIEV_STATUS' AND CODE = V_CODE AND ACTIVE_FLAG = 'Y'
}
OIDISSUE_FIND_V_HEADER_BLOCK{
SELECT
  V.OFFENDER_ID,
  V.ALIAS_OFFENDER_ID,
  V.OFFENDER_ID_DISPLAY,
  V.LAST_NAME,
  V.FIRST_NAME,
  V.MIDDLE_NAME,
  V.SUFFIX,
  V.BIRTH_DATE,
  V.OFFENDER_BOOK_ID,
  V.BOOKING_NO,
  V.BOOKING_BEGIN_DATE,
  V.BOOKING_END_DATE,
  V.AGY_LOC_ID,
  V.AGENCY_IML_ID,
  V.LIVING_UNIT_ID,
  V.DISCLOSURE_FLAG,
  V.ACTIVE_FLAG,
  V.BOOKING_STATUS,
  V.LIVING_UNIT_DESCRIPTION,
  V.IN_OUT_STATUS,
  V.STATUS_DISPLAY,
  V.ROOT_OFFENDER_ID,
  V.ASSIGNED_STAFF_ID,
  V.AGY_LOC_TYPE,
  V.CREATE_AGY_LOC_ID,
  V.BOOKING_TYPE,
  V.BOOKING_CREATED_DATE,
  V.LOCATION_CODE,
  V.LIV_UNIT_DESC,
  V.INTAKE_AGY_LOC_ID,
  V.COMMUNITY_ACTIVE_FLAG,
  CREATE_INTAKE_AGY_LOC_ID,
  V.COMMUNITY_STATUS,
  V.STATUS_REASON,
  V.HEADER_STATUS,
  V.AGE,
  V.GENDER,
  V.OFFICER,
  V.PRISON_LOCATION,
  V.OFF_ALERTS,
  V.STATUS_1,
  V.STATUS_2,
  V.STATUS_3,
  V.ETHNICITY,
  V.MOVEMENT_REASON,
  V.OFF_SUP_LEVEL,
  V.SEX
FROM V_HEADER_BLOCK_FN(:userId) V WHERE

}
FIND_WORKING_CASELOAD_ID {
SELECT WORKING_CASELOAD_ID FROM STAFF_MEMBERS WHERE USER_ID =:userId
}
DAYS_RESPOND_DATA {
SELECT DAYS_RESPOND
           FROM GRIEVANCE_TXNS
          WHERE GRIEV_TYPE = :GRIEVETYPE
            AND TXN_TYPE = :TXNTYPE
}
UPDATE_OFFENDER_GRIEVANCE_TXNS_PRE_INSERT {
UPDATE OFFENDER_GRIEVANCE_TXNS 
			   	   SET STATUS = 'I',
			   	   MODIFY_DATETIME  = current_timestamp ,MODIFY_USER_ID  =:modifyUserId
			   	 WHERE TXN_SEQ < :txnSeq
			   	   AND STATUS = 'A'
			   	   AND GRIEVANCE_ID = :grievanceId
}
FIND_MAX_START_DATE {
SELECT MAX(START_DATE)
        FROM OFFENDER_GRIEVANCE_TXNS
       WHERE GRIEVANCE_ID = :grievanceId
}
FIND_MAX_GRIEVANCE_ID {
SELECT MAX(GRIEVANCE_ID) FROM OFFENDER_GRIEVANCES
}
FIND_MAX_GRIEV_TYPE {
SELECT GRIEV_TYPE FROM OFFENDER_GRIEVANCES where GRIEVANCE_ID = :GRIEVANCEID
}
OIDISSUE_OFFENDER_GRIEVANCE_TXNS_DAYS_LEFT {
	SELECT count(*) FROM OFFENDER_GRIEVANCE_TXNS WHERE GRIEVANCE_ID = :GRIEVANCEID AND STATUS = 'I'
}
OIDISSUE_ENABLE_STAFF_BUTTON {
SELECT 1 FROM OFFENDER_GRIEVANCES WHERE GRIEVANCE_ID = :GRIEVANCE_ID
}

OIDISSUE_OFFENDER_GRIEV_STAFFS_VALID {
SELECT COUNT(*)
	  FROM offender_griev_staffs
	 WHERE grievance_id = :GRIEVANCEID
}
OIDISSUE_OFFENDERGRIEVANCES_DELETE_OFFENDER_GRIEVANCES{
delete from  OFFENDER_GRIEVANCES  WHERE GRIEVANCE_ID  = :grievanceId
}

