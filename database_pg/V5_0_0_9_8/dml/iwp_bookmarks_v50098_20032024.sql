update
	oms_owner.iwp_bookmarks
set
	sql_text = 'SELECT a.obs_oopcid, a.obs_oopcsdte, a.obs_oopcvar, a.obs_oopcstme, a.obs_oopcdte, a.obs_oopctme, a.obs_oopcfreq, a.obs_oopcstaf, a.comment_text, CASE WHEN a.activity IS NULL THEN (SELECT STRING_AGG(description, '', '') FROM reference_codes rc JOIN off_obs_add_details ooad ON rc.code = ooad.detail_code WHERE rc.domain = ''ACTIVITY'' AND ooad.obs_type_version_id = ? AND ooad.detail_type = ''ACTIVITY'' ) ELSE a.activity END AS activity, CASE WHEN a.cell_cnditns IS NULL THEN (SELECT STRING_AGG(description, '', '') FROM reference_codes rc JOIN off_obs_add_details ooad ON rc.code = ooad.detail_code WHERE rc.domain = ''CELL_CNDITNS'' AND ooad.obs_type_version_id = ? AND ooad.detail_type = ''CELL_CNDITNS'' ) ELSE a.cell_cnditns END AS cell_cnditns, CASE WHEN a.com_det_cat IS NULL THEN (SELECT STRING_AGG(description, '', '') FROM reference_codes rc JOIN off_obs_add_details ooad ON rc.code = ooad.detail_code WHERE rc.domain = ''COM_DET_CAT'' AND ooad.obs_type_version_id = ? AND ooad.detail_type = ''COM_DET_CAT'' ) ELSE a.com_det_cat END AS com_det_cat, CASE WHEN a.not_in_cell IS NULL THEN (SELECT STRING_AGG(description, '', '') FROM reference_codes rc JOIN off_obs_add_details ooad ON rc.code = ooad.detail_code WHERE rc.domain = ''NOT_IN_CELL'' AND ooad.obs_type_version_id = ? AND ooad.detail_type = ''NOT_IN_CELL'' ) ELSE a.not_in_cell END AS not_in_cell FROM ( SELECT obp.check_id AS obs_oopcid, TO_CHAR(obp.schedule_datetime, ''DD-MM-YYYY'') AS obs_oopcsdte, GREATEST((EXTRACT(epoch FROM check_datetime) * 1000 - EXTRACT(epoch FROM obp.schedule_datetime) * 1000 - ( SELECT frequency FROM offender_observation_types WHERE obs_type_version_id = ? )) / 60000, 0) AS obs_oopcvar, TO_CHAR(obp.schedule_datetime, ''HH24:MI'') AS obs_oopcstme, TO_CHAR(obp.check_datetime , ''DD-MM-YYYY'') AS obs_oopcdte, TO_CHAR(obp.check_datetime, ''HH24:MI'') AS obs_oopctme, ( SELECT frequency FROM offender_observation_types WHERE obs_type_version_id = ? ) AS obs_oopcfreq, ( SELECT last_name || '','' || '' '' || first_name AS user_id FROM staff_members sm WHERE staff_id = obp.performing_staff_id ) AS obs_oopcstaf, obp.comment_text, ( SELECT STRING_AGG(rc.description, '','') FROM reference_codes rc JOIN off_obs_add_check_details ooacd_sub ON rc.code = ooacd_sub.detail_code WHERE ooacd_sub.obs_type_version_id = ? AND ooacd_sub.detail_type = ''ACTIVITY'' AND ooacd_sub.check_id = obp.check_id ) AS activity, ( SELECT STRING_AGG(rc.description, '','') FROM reference_codes rc JOIN off_obs_add_check_details ooacd_sub ON rc.code = ooacd_sub.detail_code WHERE ooacd_sub.obs_type_version_id = ? AND ooacd_sub.detail_type = ''CELL_CNDITNS'' AND ooacd_sub.check_id = obp.check_id ) AS cell_cnditns, ( SELECT STRING_AGG(rc.description, '','') FROM reference_codes rc JOIN off_obs_add_check_details ooacd_sub ON rc.code = ooacd_sub.detail_code WHERE ooacd_sub.obs_type_version_id = ? AND ooacd_sub.detail_type = ''COM_DET_CAT'' AND ooacd_sub.check_id = obp.check_id ) AS com_det_cat, ( SELECT STRING_AGG(rc.description, '','') FROM reference_codes rc JOIN off_obs_add_check_details ooacd_sub ON rc.code = ooacd_sub.detail_code WHERE ooacd_sub.obs_type_version_id = ? AND ooacd_sub.detail_type = ''NOT_IN_CELL''AND ooacd_sub.check_id = obp.check_id ) AS not_in_cell FROM OFF_OBS_PERIOD_CHECKS obp LEFT join off_obs_add_check_details ooacd ON obp.check_id = ooacd.check_id WHERE obp.OBS_PERIOD_ID = ? GROUP BY obp.check_id ) AS a',
	modify_datetime = current_timestamp ,
	modify_user_id = 'OMS_OWNER'
where
	bookmark_name = 'OFF_OBS_CHEC';
